!function(a){function b(b){for(var g=a.extend(!0,[],b),h=g.length-1;h>0;h--)for(var i=c(g[h]),j=0;h>j;j++){var k=c(g[j]);0!=i.type&&i.type==k.type&&i.startTime<k.endTime&&i.endTime>k.startTime&&(g[j]=k.type+" "+e(i.startTime,k.startTime)+"-"+f(i.endTime,k.endTime),g[h]="0 00:00:00-23:59:59")}return g.sort(d)}function c(a){var b=a.match(h),c=null;return c=b?{type:7&b[1].toInt(),startTime:b[2],endTime:b[3]}:{type:0,startTime:"00:00:00",endTime:"23:59:59"}}function d(a,b){var d=c(a),e=c(b);return d.type>e.type?-1:d.type<e.type?1:d.startTime+d.endTime>e.startTime+e.endTime?1:-1}function e(a,b){return b>a?a:b}function f(a,b){return a>b?a:b}function g(a){return 10>a?"0"+a:a}var h=/(\d+) (\d\d:\d\d:\d\d)-(\d\d:\d\d:\d\d)/,i=86399;a.widget("dui.schedule",{options:{holiday:!1,type:["general","motion","alarm"],width:528,height:210},_create:function(){this.element.toggleClass("u-schedule",!0),this.options.holiday&&(this.options.height=240,this.element.toggleClass("holiday",!0)),this.setType(this.options.type),this._addEvent(),this.timeSchedules=[];for(var a,b=7,c=[];b--;){for(c=[],a=6;a--;)c.push("0 00:00:00-23:59:59");this.timeSchedules.push(c)}this.options.holiday&&this.timeSchedules.push(c)},render:function(b){if(b){{var c=this;this.options.displayMode}c.element.empty(),c.timeSchedules=b,c._fixTimeSchedules(),a.each(c.timeSchedules,function(b,d){a.each(d,function(a,d){var e=d.split(" ")[0],f=d.split(" ")[1];1&e&&c._addElement("general",f,30*b+1),2&e&&c._addElement("motion",f,30*b+11),4&e&&c._addElement("alarm",f,30*b+21)})})}},setType:function(b){var c=0;-1!==a.inArray("general",b)&&(c+=1),-1!==a.inArray("motion",b)&&(c+=2),-1!==a.inArray("alarm",b)&&(c+=4),this.type=c},getTimeSchedules:function(){return this.timeSchedules},setTimeSchedules:function(a){this.timeSchedules=a,this.render(a)},_addEvent:function(){this._on({mousedown:this._onMouseDown}),a(document).on("contextmenu",".u-schedule",this._onContextMenu);var b=this;a(window).on("resize",function(){b.element._position=null})},_onMouseDown:function(b){if(!this.mousedown_position){var c=this.element.offset();this.mousedown_position={x:Math.max(b.pageX-c.left).limit(1,this.options.width+1),y:Math.max(b.pageY-c.top).limit(1,this.options.height)},this.mousedown_mode=b.target==this.element[0]?"add":"delete",this.mousedown_ele=a('<div class="u-schedule-rect"></div>'),this.mousedown_ele.css("background-color","add"==this.mousedown_mode?"#444":"#fff"),this.element.append(this.mousedown_ele),this.element._position=c,this._on(a(document),{mouseup:this._onMouseUp,mousemove:this._onMouseMove}),a(document).disableSelection()}},_onMouseUp:function(b){if(this.mousedown_position){var c=this.element._position,d={x:(b.pageX-c.left).limit(1,this.options.width+1),y:(b.pageY-c.top).limit(1,this.options.height)},e=this.mousedown_position,f={left:Math.min(d.x,e.x),top:Math.min(d.y,e.y),width:Math.abs(d.x-e.x),height:Math.abs(d.y-e.y)};this.mousedown_position=null,this.mousedown_ele.remove(),this._afterDraw(f),this._off(a(document)),a(document).enableSelection()}},_onMouseMove:function(a){if(this.mousedown_position){var b=this.element._position,c={x:(a.pageX-b.left).limit(1,this.options.width+1),y:(a.pageY-b.top).limit(1,this.options.height)},d=this.mousedown_position,e={left:Math.min(c.x,d.x),top:Math.min(c.y,d.y),width:Math.abs(c.x-d.x),height:Math.abs(c.y-d.y)};return this.mousedown_ele&&this.mousedown_ele.css(e),a.preventDefault(),!1}},_onContextMenu:function(){return!1},_afterDraw:function(a){"add"==this.mousedown_mode?a.width&&this._addTimeSection(a):this._removeTimeSection(a)},_addTimeSection:function(b){var d=this,e=this._rectToTimeObj(b);a.each(this.timeSchedules,function(a,f){if(b.top<30*(a+1)&&b.top+b.height>30*a){for(var g=0,h=f.length;h>g;g++){var i=c(f[g]);if((7&i.type)==d.type&&i.endTime>e.startTime&&i.startTime<e.endTime)return void(f[g]=i.type+" "+(e.startTime<i.startTime?e.startTime:i.startTime)+"-"+(e.endTime>i.endTime?e.endTime:i.endTime))}for(var g=0,h=f.length;h>g;g++){var j=f[g].split(" ")[0].toInt();if(!(7&j))return void(f[g]=(j|d.type)+" "+e.startTime+"-"+e.endTime)}}}),this.render(this.timeSchedules),this._trigger("change",null,[a.extend(!0,[],this.timeSchedules)])},_removeTimeSection:function(b){var d=this,e=this._rectToTimeObj(b);a.each(this.timeSchedules,function(f,g){b.top<30*(f+1)&&b.top+b.height>30*f&&a.each(g,function(a,b){var f=c(b);if(f.endTime>e.startTime&&f.startTime<e.endTime){var h=c(g[a]);1&d.type&&(h.type=65534&h.type),2&d.type&&(h.type=65533&h.type),4&d.type&&(h.type=65531&h.type),g[a]=7&h.type?h.type+" "+h.startTime+"-"+h.endTime:"0 00:00:00-23:59:59"}})}),this.render(this.timeSchedules),this._trigger("change",null,[a.extend(!0,[],this.timeSchedules)])},_addElement:function(b,c,d){var e=this._timeToRect(c),f=a("<div></div>");f.addClass("u-schedule-"+b).css({left:e.left,width:e.width,top:d}),this.element.append(f)},_timeToRect:function(a){var b=a.split("-")[0],c=a.split("-")[1],d=this._timeToPoint(b),e=this._timeToPoint(c)-d;return{left:d,width:e}},_rectToTimeObj:function(a){return{startTime:this._pointToTime(a.left),endTime:this._pointToTime(a.left+a.width)}},_timeToPoint:function(b){var c=a.map(b.split(":"),function(a){return a.toInt()});return(3600*c[0]+60*c[1]+c[2])/i*this.options.width+1},_pointToTime:function(a){var b=(a-1)/this.options.width*i,c=(b/3600).toInt(),d=((b-3600*c)/60).toInt(),e=(b%60).toInt();return g(c)+":"+g(d)+":"+g(e)},_fixTimeSchedules:function(){var c=this;a.each(c.timeSchedules,function(a,d){c.timeSchedules[a]=b(d)})}})}(jQuery);