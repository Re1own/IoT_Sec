--[[
SAMSUNG云台协议存在以下问题:
1 PATTERN只有START和STOP指令, 没有相应的设置指令.
2 AUTO SCAN只有START和STOP指令, 没有相应的左右边界值的设定功能.
--]]

local Protocol = {};

-- 表示数值可以用16或10进制(最小值，最大值)
Protocol.Attr = 
{
	-- 协议的显示名称,不能超过16字符，目前暂不支持中文
	Name = "SAMSUNG",	
		
	-- 指明是云台协议还是矩阵协议，使用"PTZ", "MATRIX"表示
	Type = "PTZ",
	
	-- 以ms为单位
	Internal = 200,
				
	-- 没有对应的地址范围，请都设成0xff
	-- 云台地址范围
	CamAddrRange 		= {0x01, 0xFF}, 
	-- 监视地址范围
	MonAddrRange		= {0x00, 0xFF},	
	-- 预置点范围
	PresetRange 		= {0x00, 0xff},
	-- 自动巡航线路范围
	TourRange		= {0xff, 0xff},
	-- 轨迹线路范围
	PatternRange		= {1, 3},
	-- 垂直速度范围
	TileSpeedRange 		= {0x00, 0x40},
	-- 水平速度范围
	PanSpeedRange 		= {0x00, 0x40},
	-- 自动扫描范围
	ScanRange 			= {0x01, 0x05},
	
	-- 辅助范围
	AuxRange 		= {0x01, 0x08},
}

Protocol.CommandAttr =
{
	-- 协议中需要更改的位置，用LUA下标表示，即下标从１开始,用10进制表示
	AddrPos 		= 3, 
	PresetPos 		= 6, 
	TileSpeedPos 		= 8,
	PanSpeedPos 		= 7,
	PatternPos 		= 6;
	AuxPos 		= 6,
}

Protocol.Command = 
{
	-- 写具体协议时只能用16进制或字符表示,没有的话就注释掉
	Start= 
	{
		--写上下左右, 左上，左下，右上，右下
		--                  1     2     3     4     5     6     7     8     9
		TileUp 		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00",
		TileDown 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x00, 0x00",
		PanLeft 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00", 
		PanRight 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x02, 0x00, 0x00, 0x00",
		LeftUp 		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x05, 0x00, 0x00, 0x00",
		LeftDown 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x09, 0x00, 0x00, 0x00",
		RightUp		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x06, 0x00, 0x00, 0x00",
		RightDown = "0xA0, 0x00, 0x00, 0x01, 0x00, 0x0A, 0x00, 0x00, 0x00",

		ZoomWide 	= "0xA0, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00, 0x00",
		ZoomTele 	= "0xA0, 0x00, 0x00, 0x01, 0x20, 0x00, 0x00, 0x00, 0x00",
		FocusNear	= "0xA0, 0x00, 0x00, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00",
		FocusFar 	= "0xA0, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00",
		IrisSmall 	= "0xA0, 0x00, 0x00, 0x01, 0x10, 0x00, 0x00, 0x00, 0x00",
		IrisLarge 	= "0xA0, 0x00, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00, 0x00",
			
		-- 预置点操作（设置，清除，转置)
		SetPreset 	= "0xA0, 0x00, 0x00, 0x03, 0x50, 0x00, 0xFF, 0xFF, 0x00",
		ClearPreset	= "0xA0, 0x00, 0x00, 0x03, 0x51, 0x00, 0xFF, 0xFF, 0x00",
		GoToPreset 	= "0xA0, 0x00, 0x00, 0x03, 0x19, 0x00, 0xFF, 0xFF, 0x00",			
			
		-- 水平旋转，
		AutoPanOn	= "0xA0, 0x00, 0x00, 0x03, 0x1A, 0x01, 0xFF, 0xFF, 0x00",
		AutoPanOff	= "0xA0, 0x00, 0x00, 0x03, 0x1A, 0x00, 0xFF, 0xFF, 0x00",
			
		-- 自动扫描，在预先设置的边界中间转动
		AutoScanOn 	= "0xA0, 0x00, 0x00, 0x03, 0x13, 0x01, 0xFF, 0xFF, 0x00",
		AutoScanOff	= "0xA0, 0x00, 0x00, 0x03, 0x13, 0x00, 0xFF, 0xFF, 0x00",
			
		-- 轨迹巡航, 一般指模式(设置开始，设置结束，运行，停止，清除模式
		StartPattern 	= "0xA0, 0x00, 0x00, 0x03, 0x1B, 0x00, 0x01, 0xFF, 0x00",
		StopPattern	= "0xA0, 0x00, 0x00, 0x03, 0x1B, 0x00, 0x00, 0xFF, 0x00",
		--ClearPattern 	= "",
				
		-- 菜单相关操作
		--                  1     2     3     4     5     6     7     8     9		
		Menu 		= "0xA0, 0x00, 0x00, 0x03, 0x17, 0x01, 0xFF, 0xFF, 0x00", 
		MenuExit 	= "0xA0, 0x00, 0x00, 0x03, 0x17, 0x00, 0xFF, 0xFF, 0x00", 
		MenuEnter 	= "0xA0, 0x00, 0x00, 0x03, 0x18, 0xFF, 0xFF, 0xFF, 0x00", 
		MenuUp = "0xA0, 0x00, 0x00, 0x03, 0x03, 0xFF, 0xFF, 0xFF, 0x00", 
		MenuDown = "0xA0, 0x00, 0x00, 0x03, 0x09, 0xFF, 0xFF, 0xFF, 0x00", 
		MenuLeft = "0xA0, 0x00, 0x00, 0x03, 0x05, 0xFF, 0xFF, 0xFF, 0x00", 
		MenuRight = "0xA0, 0x00, 0x00, 0x03, 0x07, 0xFF, 0xFF, 0xFF, 0x00", 
		--[[ 
		三维定位功能，前九个字节表示水平方向的运动，中间九个字节表示垂直方向的运动，最后九个字节表示变倍
		前九个字节的含义：3字节地址,5字节表示向左还是向右：左1右0,6，7 字节表示相对运动的值。范围为：0 - 708H
		中间九个字节的含义：12字节地址，14字节表示向上还是向下：上0下1，15，16字节表示垂直相对运动的值	，范围为：(见下表)
		后九个字节的含义：21字节表示地址，23个字节表示变倍大小：大0小1，24，25字节表示变倍的大小。
		--]]
		Position  = "a0 00 01 20 00 05 00 ff da a0 00 01 30 01 00 50 ff 7e a0 00 01 40 00 0d 2c ff 86",
		
	},
	Stop = 
	{
		--                  1     2     3     4     5     6     7     8     9	
		TileUp 		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		TileDown 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		PanLeft 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		PanRight 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		LeftUp		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		LeftDown	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		RightUp		= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		RightDown	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		
		ZoomWide 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		ZoomTele 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		FocusNear 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		FocusFar 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		IrisSmall 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
		IrisLarge 	= "0xA0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00",
	},
}

Protocol.Checksum = function (s)
	--第9位为校验码, 其值为0xFFFF减去第2到8位之和再取低8位.
	if table.getn(s) == 9 then
		local sum = s[2] + s[3] + s[4] + s[5] + s[6] + s[7] + s[8];
		s[9] = bits.band(0xFFFF - sum, 0xff);
	else
		local sum1 = s[2] + s[3] + s[4] + s[5] + s[6] + s[7] + s[8];
		s[9] = bits.band(0xFFFF - sum1,0xff);
		
		local sum2 = s[11] + s[12] + s[13] + s[14] + s[15] + s[16] + s[17];
		s[18] = bits.band(0xFFFF- sum2,0xff);
		
		local sum3 = s[20] + s[21] + s[22] + s[23] + s[24] + s[25] + s[26];
		s[27] = bits.band(0xFFFF - sum3,0xff);
	end;
	return s;
end;

Protocol.CamAddrProcess = function(s, addr)
	local addr = math.mod(addr,256);
	if table.getn(s) == 9 then
		s[3] = addr;
	else
		s[21] , s[12] , s[3] = addr,addr,addr;		
	end;
	return s;
end;

Protocol.PatternProcess = function(s, num)
	s[6] = num;
	return s;
end;

Protocol.SpeedProcess = function(opttable, arg1, arg2)

	if opttable[6] ~= 0 then
		opttable[8] = arg1;
		opttable[7] = arg2;
	end;
	return opttable;
end;

Protocol.PositionProcess = function(s, hor, ver, zoom)
	-- 下面只处理快速定位功能
	print("hor is:",hor);
	print("ver is :",ver);
	print("zoom is:",zoom);
	-- 左，下 时hor 和ver 是正数
	-- 右，上 时hor 和ver 是负数
	--[[ 
		三维定位功能，前九个字节表示水平方向的运动，中间九个字节表示垂直方向的运动，最后九个字节表示变倍
		前九个字节的含义：3字节地址,5字节表示向左还是向右：左1右0,6，7 字节表示相对运动的值。范围为：0 - 708H
		中间九个字节的含义：12字节地址，14字节表示向上还是向下：上0下1，15，16字节表示垂直相对运动的值	，范围为：(见下表)
		后九个字节的含义：21字节表示地址，23个字节表示变倍大小：大0小1，24，25字节表示变倍的大小。
	--]]
	local max_pos_zoom = 22;
	zoom_num_table = {0x008,0x574,0x7B8,0x90C,0x9F4,0xAA0,0xB2C,0xBA0,0xC04,0xC58,0xCA4,0xCEC,0xD28, 0xD5C,0xD8C,0xDB4,0xDD8,0xDF8,0xE10,0xE28,0xE38,0xE44};
	local max_pan_value = 0x708;
	local max_tilt_value = 0x16;
	
	if hor >= 0 then
		s[5] = 0x00;
		print("right");
	else 
		print("left");
		s[5] = 0x01;
	end;
	hor = math.abs(hor);
	
	if ver >= 0 then
		print("down");
		s[14] = 0x01;
	else
		print("up");
		s[14] = 0x00;
	end;
	ver = math.abs(ver);
	
	if zoom > 0 then
		print("room tele");
		s[23] = 0x00;
	else
		print("room wide");
		s[23] = 0x01;
	end;
	local zoom_value = math.mod(bits.band(math.abs(zoom),0x7f),0x04);
	print("zoom_value:",zoom_value);
	--处理水平位置
	local pan = math.floor(hor/80);
	print("1");
	s[6] = bits.band(math.floor(pan/256),0xff);
	print("2");
	s[7] = bits.band(math.mod(pan,256),0xff)
	--处理垂直位置
	print("3");
	local tilt = math.floor(ver/226);
	print("4");
	s[15] = bits.band(math.floor(tilt/256),0xff);
	print("5");
	s[16] = bits.band(math.mod(tilt,256),0xff);
	--处理变倍大小
	print("6");
	if zoom_value >= 1 then
	print("7");
		print("zoom_num_table[zoom_value]:",zoom_num_table[zoom_value]);
		local zoom_num = zoom_num_table[zoom_value];
		s[24] = bits.band(math.floor(zoom_num/256),0xff);
		s[25] = bits.band(math.mod(zoom_num,256),0xff);
	end;
	
	return s;
end;

return Protocol;